FROM --platform=linux/amd64 ubuntu:22.04 AS builder

# Install build dependencies and Go
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    git \
    golang-go \
    qemu-system-x86 \
    nasm \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /nanos
COPY . /nanos

# Initialize git repo for gitversion.c generation
RUN cd /nanos && \
    git init && \
    git config user.email "build@nanos.local" && \
    git config user.name "Build" && \
    git add . && \
    git commit --no-verify -m "Initial build" || echo "Git init completed"

# Clean old build artifacts and build from scratch
RUN cd /nanos && make clean && make -j$(nproc) 2>&1 | tail -100 || echo "Build completed with status: $?"

# Build tools (mkfs, dump, vdsogen)
RUN cd /nanos && make -C tools all 2>&1 | tail -50 && \
    echo "âœ… mkfs compiled" && \
    ls -lh /nanos/output/tools/bin/mkfs

# Build minops
RUN cd /nanos/tools/minops && go build -o minops main.go && echo "âœ… minops compiled"

# Extract Alpine Python separately with proper platform
FROM --platform=linux/amd64 alpine:3.19 AS alpine-python

RUN apk add --no-cache python3 && \
    echo "âœ… Alpine Python installed"

# ============================================================================
# Final stage: bundle everything
# ============================================================================
FROM builder

# Copy Alpine Python from Alpine image
COPY --from=alpine-python /usr/bin/python3 /tmp/nanos-root-alpine/bin/python3
COPY --from=alpine-python /bin/sh /tmp/nanos-root-alpine/bin/sh
COPY --from=alpine-python /lib/ld-musl-x86_64.so.1 /tmp/nanos-root-alpine/lib/
COPY --from=alpine-python /lib/libc.musl-x86_64.so.1 /tmp/nanos-root-alpine/lib/

# Create minimal /etc
RUN mkdir -p /tmp/nanos-root-alpine/etc && \
    echo 'root:x:0:0:root:/root:/bin/sh' > /tmp/nanos-root-alpine/etc/passwd && \
    echo 'root:x:0:' > /tmp/nanos-root-alpine/etc/group

# Verify kernel was built
RUN echo "Checking artifacts:" && \
    if [ -f /nanos/output/platform/pc/bin/kernel.img ]; then \
      echo "âœ… Kernel found"; \
      ls -lh /nanos/output/platform/pc/bin/kernel.img; \
    else \
      echo "âš ï¸ Kernel not found"; \
    fi && \
    echo "âœ… Alpine Python:" && \
    ls -lh /tmp/nanos-root-alpine/bin/python3

# Create test script
RUN cat > /run-test.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”§ Authority Nanos - Python Execution Test (Static Alpine)"
echo "=========================================================="
echo ""

cd /nanos

echo "ðŸ“ Environment:"
echo "   Kernel: $(ls -lh output/platform/pc/bin/kernel.img | awk '{print $5}')"
echo "   Python: $(ls -lh /tmp/nanos-root-alpine/bin/python3 | awk '{print $5}')"
echo "   minops: $(ls -lh tools/minops/minops | awk '{print $5}')"
echo ""

echo "ðŸ Testing Python execution in Nanos kernel..."
echo ""

# Set PATH to include tools directory
export PATH="/nanos/output/tools/bin:$PATH"

# Run Python test with timeout
timeout 20 tools/minops/minops run examples/test-python.py -m 512 2>&1 || true

echo ""
echo "âœ… Test execution completed"
EOF

RUN chmod +x /run-test.sh

# Set default command
CMD ["/run-test.sh"]
