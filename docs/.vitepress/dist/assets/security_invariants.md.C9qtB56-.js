import{_ as t,C as l,c as r,o as a,ah as n,b as p,w as i,a as o,G as h,ai as c}from"./chunks/framework.CpSv75ol.js";const v=JSON.parse('{"title":"Security Invariants","description":"","frontmatter":{},"headers":[],"relativePath":"security/invariants.md","filePath":"security/invariants.md","lastUpdated":1768651549000}'),d={name:"security/invariants.md"};function k(u,s,b,g,m,E){const e=l("Mermaid");return a(),r("div",null,[s[1]||(s[1]=n(`<h1 id="security-invariants" tabindex="-1">Security Invariants <a class="header-anchor" href="#security-invariants" aria-label="Permalink to &quot;Security Invariants&quot;">​</a></h1><div class="tip custom-block"><p class="custom-block-title">Formal Guarantees</p><p>These four invariants MUST hold at ALL times. They are not guidelines—they are mathematical properties that the implementation MUST preserve.</p></div><p>Authority Nanos enforces four foundational security invariants that provide mathematical guarantees about agent behavior. Any violation is a <strong>P0 security incident</strong>.</p><h2 id="i-the-four-invariants" tabindex="-1">I. The Four Invariants <a class="header-anchor" href="#i-the-four-invariants" aria-label="Permalink to &quot;I. The Four Invariants&quot;">​</a></h2><h3 id="inv-1-no-bypass-invariant" tabindex="-1">INV-1: No-Bypass Invariant <a class="header-anchor" href="#inv-1-no-bypass-invariant" aria-label="Permalink to &quot;INV-1: No-Bypass Invariant&quot;">​</a></h3><blockquote><p><strong>Statement</strong>: Agents cannot perform external IO except via kernel IPC.</p></blockquote><h4 id="formal-definition" tabindex="-1">Formal Definition <a class="header-anchor" href="#formal-definition" aria-label="Permalink to &quot;Formal Definition&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>∀ agent A, ∀ IO operation O:</span></span>
<span class="line"><span>    O is external ⟹ O goes through kernel IPC channel</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="enforcement-mechanisms" tabindex="-1">Enforcement Mechanisms <a class="header-anchor" href="#enforcement-mechanisms" aria-label="Permalink to &quot;Enforcement Mechanisms&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Layer</th><th>Mechanism</th><th>Blocks</th></tr></thead><tbody><tr><td><strong>Syscall</strong></td><td>Seccomp-BPF filter</td><td><code>socket(AF_INET*)</code>, <code>execve</code>, <code>fork</code>, <code>ptrace</code></td></tr><tr><td><strong>Network</strong></td><td>Namespace isolation</td><td>All except loopback</td></tr><tr><td><strong>Filesystem</strong></td><td>Mount namespace</td><td>Write access outside scratch</td></tr><tr><td><strong>Process</strong></td><td>FD inheritance blocking</td><td>Pre-existing connections</td></tr></tbody></table><h4 id="verification" tabindex="-1">Verification <a class="header-anchor" href="#verification" aria-label="Permalink to &quot;Verification&quot;">​</a></h4><div class="danger custom-block"><p class="custom-block-title">Required</p><p>Confinement escape tests MUST pass before any agent execution.</p></div><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Test confinement</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authority</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> confinement</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr><h3 id="inv-2-capability-invariant" tabindex="-1">INV-2: Capability Invariant <a class="header-anchor" href="#inv-2-capability-invariant" aria-label="Permalink to &quot;INV-2: Capability Invariant&quot;">​</a></h3><blockquote><p><strong>Statement</strong>: Every effectful syscall must carry a valid, non-revoked capability whose scope subsumes the request.</p></blockquote><h4 id="formal-definition-1" tabindex="-1">Formal Definition <a class="header-anchor" href="#formal-definition-1" aria-label="Permalink to &quot;Formal Definition&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>∀ syscall S where effect(S) = true:</span></span>
<span class="line"><span>    ∃ capability C in request R such that:</span></span>
<span class="line"><span>        valid(C) ∧ ¬revoked(C) ∧ scope(C) ⊇ resource(S)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="validation-requirements" tabindex="-1">Validation Requirements <a class="header-anchor" href="#validation-requirements" aria-label="Permalink to &quot;Validation Requirements&quot;">​</a></h4><p><strong>valid(C)</strong>: HMAC-SHA256 verification passes</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verify_capability</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">capability_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. Check HMAC signature</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint8_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> expected_mac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    compute_hmac_sha256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cap-&gt;data, cap-&gt;len, secret_key, expected_mac);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">memcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cap-&gt;mac, expected_mac, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2. Check not revoked</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">is_revoked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cap-&gt;token_id)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3. Check scope matches request</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> scope_subsumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cap, request);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>¬revoked(C)</strong>: Token ID not in revocation map</p><p><strong>scope(C) ⊇ resource(S)</strong>:</p><ul><li>Capability type matches operation type</li><li>Resource pattern matches target resource</li><li>Methods include requested method</li><li>TTL not expired</li><li>Rate limit not exceeded</li></ul><div class="warning custom-block"><p class="custom-block-title">Strict Enforcement</p><p>Capability verification is called BEFORE any syscall dispatch. Ambiguous cases are denied.</p></div><hr><h3 id="inv-3-budget-invariant" tabindex="-1">INV-3: Budget Invariant <a class="header-anchor" href="#inv-3-budget-invariant" aria-label="Permalink to &quot;INV-3: Budget Invariant&quot;">​</a></h3><blockquote><p><strong>Statement</strong>: Admission control rejects any operation that would exceed declared run budgets.</p></blockquote><h4 id="formal-definition-2" tabindex="-1">Formal Definition <a class="header-anchor" href="#formal-definition-2" aria-label="Permalink to &quot;Formal Definition&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>∀ operation O with cost(O) = c:</span></span>
<span class="line"><span>    let current = Σ(costs of completed operations in run)</span></span>
<span class="line"><span>    let budget = declared_budget(run_id, resource_type)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    PRE: current + c ≤ budget</span></span>
<span class="line"><span>    POST: current&#39; = current + c</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    If PRE fails: reject with E_BUDGET_EXCEEDED (no state change)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="budget-dimensions" tabindex="-1">Budget Dimensions <a class="header-anchor" href="#budget-dimensions" aria-label="Permalink to &quot;Budget Dimensions&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Resource</th><th>Unit</th><th>Default Limit</th><th>Enforcement</th></tr></thead><tbody><tr><td><strong>LLM Input Tokens</strong></td><td>tokens</td><td>1,000,000</td><td>Pre-call check</td></tr><tr><td><strong>LLM Output Tokens</strong></td><td>tokens</td><td>100,000</td><td>Post-call decrement</td></tr><tr><td><strong>Tool Calls</strong></td><td>count</td><td>100</td><td>Atomic counter</td></tr><tr><td><strong>Wall Time</strong></td><td>ms</td><td>300,000</td><td>Deadline timer</td></tr><tr><td><strong>Heap Objects</strong></td><td>count</td><td>10,000</td><td>Allocator hook</td></tr><tr><td><strong>Blob Storage</strong></td><td>bytes</td><td>100 MB</td><td>Quota system</td></tr></tbody></table><h4 id="implementation" tabindex="-1">Implementation <a class="header-anchor" href="#implementation" aria-label="Permalink to &quot;Implementation&quot;">​</a></h4><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_budget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">run_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">resource_type_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">uint64_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> cost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint64_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> atomic_load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">run-&gt;budget[type].used);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint64_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> run-&gt;budget[type].limit;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Atomic test-and-set</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint64_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> new_value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cost;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (new_value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> limit) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> E_BUDGET_EXCEEDED;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atomic_compare_exchange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">run-&gt;budget[type].used, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">current, new_value)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Race detected, retry</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_budget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(run, type, cost);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">No Soft Limits</p><p>Budget checks are hard enforcement only. No warnings, no grace periods—operations are rejected at the limit.</p></div><hr><h3 id="inv-4-log-commitment-invariant" tabindex="-1">INV-4: Log Commitment Invariant <a class="header-anchor" href="#inv-4-log-commitment-invariant" aria-label="Permalink to &quot;INV-4: Log Commitment Invariant&quot;">​</a></h3><blockquote><p><strong>Statement</strong>: Each committed transition appends a log entry whose hash chain validates from genesis to head.</p></blockquote><h4 id="formal-definition-3" tabindex="-1">Formal Definition <a class="header-anchor" href="#formal-definition-3" aria-label="Permalink to &quot;Formal Definition&quot;">​</a></h4><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>∀ state transition T from Σ to Σ&#39;:</span></span>
<span class="line"><span>    ∃ log entry E such that:</span></span>
<span class="line"><span>        E.prev_hash = hash(log[n-1])</span></span>
<span class="line"><span>        E.this_hash = SHA256(E.prev_hash || canonical(E))</span></span>
<span class="line"><span>        E.req_hash = SHA256(canonical(request))</span></span>
<span class="line"><span>        E.res_hash = SHA256(canonical(response))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        AND: log&#39; = log ++ [E]</span></span>
<span class="line"><span>        AND: Response sent to agent only AFTER fsync(log)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="hash-chain-properties" tabindex="-1">Hash Chain Properties <a class="header-anchor" href="#hash-chain-properties" aria-label="Permalink to &quot;Hash Chain Properties&quot;">​</a></h4>`,41)),(a(),p(c,null,{default:i(()=>[h(e,{id:"mermaid-302",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20Genesis%5BGenesis%3Cbr%2F%3Eall%20zeros%5D%20--%3E%20E1%5BEntry%201%3Cbr%2F%3Ehash%E2%82%81%5D%0A%20%20%20%20E1%20--%3E%20E2%5BEntry%202%3Cbr%2F%3Ehash%E2%82%82%5D%0A%20%20%20%20E2%20--%3E%20E3%5BEntry%203%3Cbr%2F%3Ehash%E2%82%83%5D%0A%20%20%20%20E3%20--%3E%20Head%5BHead%3Cbr%2F%3Ehash%E2%82%99%5D%0A%20%20%20%20%0A%20%20%20%20style%20Genesis%20fill%3A%2327ae60%0A%20%20%20%20style%20Head%20fill%3A%23e74c3c%0A"})]),fallback:i(()=>[...s[0]||(s[0]=[o(" Loading... ",-1)])]),_:1})),s[2]||(s[2]=n(`<p><strong>Properties</strong>:</p><ul><li><strong>Append-only</strong>: No deletions, no modifications</li><li><strong>Tamper-evident</strong>: Any modification breaks the chain</li><li><strong>Non-repudiation</strong>: Agent cannot deny actions (req_hash proves request)</li></ul><h4 id="verification-algorithm" tabindex="-1">Verification Algorithm <a class="header-anchor" href="#verification-algorithm" aria-label="Permalink to &quot;Verification Algorithm&quot;">​</a></h4><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> verify_chain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(log):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;Verify hash chain from genesis to head&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    expected_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> GENESIS_HASH</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # All zeros</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Check prev_hash matches expected</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry.prev_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expected_hash:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Chain break at entry </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entry.seq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Recompute this_hash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        canonical </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canonicalize(entry)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        computed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sha256(entry.prev_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canonical)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry.this_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> computed:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hash mismatch at entry </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entry.seq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        expected_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> entry.this_hash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Chain valid&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="danger custom-block"><p class="custom-block-title">Synchronous Logging</p><p>Log writes occur in the same transaction as state mutations. The agent receives a response ONLY AFTER <code>fsync()</code> completes.</p></div><hr><h2 id="ii-security-theorems" tabindex="-1">II. Security Theorems <a class="header-anchor" href="#ii-security-theorems" aria-label="Permalink to &quot;II. Security Theorems&quot;">​</a></h2><h3 id="theorem-1-containment" tabindex="-1">Theorem 1: Containment <a class="header-anchor" href="#theorem-1-containment" aria-label="Permalink to &quot;Theorem 1: Containment&quot;">​</a></h3><blockquote><p>Under adversary classes I-III, no side effects occur except through validated syscalls.</p></blockquote><p><strong>Adversary Classes</strong>:</p><ul><li><strong>Class I</strong>: Arbitrary malicious inputs (prompt injection)</li><li><strong>Class II</strong>: Compromised agent logic (model poisoning)</li><li><strong>Class III</strong>: Tool runtime escape attempts</li></ul><p><strong>Proof Sketch</strong>:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Given: INV-1 (no bypass) + INV-2 (capability required)</span></span>
<span class="line"><span>Assume: Side effect E occurs outside kernel validation</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Case 1: E via direct IO</span></span>
<span class="line"><span>    → Blocked by confinement (INV-1) ⊥</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Case 2: E via syscall without capability</span></span>
<span class="line"><span>    → Rejected by capability check (INV-2) ⊥</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Case 3: E via forged capability</span></span>
<span class="line"><span>    → HMAC verification fails (INV-2) ⊥</span></span>
<span class="line"><span></span></span>
<span class="line"><span>∴ No such E exists. QED.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><hr><h3 id="theorem-2-audit-completeness" tabindex="-1">Theorem 2: Audit Completeness <a class="header-anchor" href="#theorem-2-audit-completeness" aria-label="Permalink to &quot;Theorem 2: Audit Completeness&quot;">​</a></h3><blockquote><p>Every state-changing operation produces a corresponding log entry whose hash commits to all prior entries.</p></blockquote><p><strong>Proof Sketch</strong>:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Given: INV-4 (log commitment)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>For any state Σ at time t:</span></span>
<span class="line"><span>    Let L = [E₀, E₁, ..., Eₙ] be the log</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ∀ i ∈ [1,n]: Eᵢ.prev_hash = hash(Eᵢ₋₁)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    To reconstruct Σ:</span></span>
<span class="line"><span>        Start from genesis state Σ₀</span></span>
<span class="line"><span>        Apply each Eᵢ sequentially</span></span>
<span class="line"><span>        Verify hash chain at each step</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    Any tampering at position k:</span></span>
<span class="line"><span>        Eₖ&#39;.this_hash ≠ Eₖ₊₁.prev_hash</span></span>
<span class="line"><span>        → Chain breaks → Detected</span></span>
<span class="line"><span></span></span>
<span class="line"><span>∴ Audit trail is complete and tamper-evident. QED.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><hr><h3 id="theorem-3-budget-enforcement" tabindex="-1">Theorem 3: Budget Enforcement <a class="header-anchor" href="#theorem-3-budget-enforcement" aria-label="Permalink to &quot;Theorem 3: Budget Enforcement&quot;">​</a></h3><blockquote><p>Resource consumption is bounded by declared budgets; exceeding operations rejected pre-execution.</p></blockquote><p><strong>Proof Sketch</strong>:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Given: INV-3 (budget invariant)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>∀ run R with budget B:</span></span>
<span class="line"><span>    Let Cᵢ = cost of operation i</span></span>
<span class="line"><span>    Let Sₙ = Σᵢ₌₁ⁿ Cᵢ (total cost after n operations)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    By INV-3: ∀ n: Sₙ + Cₙ₊₁ &gt; B ⟹ operation n+1 rejected</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ∴ Sₙ ≤ B for all n</span></span>
<span class="line"><span>    ∴ Total resource consumption ≤ B. QED.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr><h2 id="iii-the-six-guarantees" tabindex="-1">III. The Six Guarantees <a class="header-anchor" href="#iii-the-six-guarantees" aria-label="Permalink to &quot;III. The Six Guarantees&quot;">​</a></h2><table tabindex="0"><thead><tr><th>#</th><th>Guarantee</th><th>Invariant Basis</th><th>Enforcement</th></tr></thead><tbody><tr><td><strong>G1</strong></td><td>Containment</td><td>INV-1, INV-2</td><td>Confinement + Capabilities</td></tr><tr><td><strong>G2</strong></td><td>Least Privilege</td><td>INV-2</td><td>Capability scope checking</td></tr><tr><td><strong>G3</strong></td><td>Audit</td><td>INV-4</td><td>Hash-chained log</td></tr><tr><td><strong>G4</strong></td><td>Replay</td><td>INV-4</td><td>Deterministic from log</td></tr><tr><td><strong>G5</strong></td><td>Bounded Cost</td><td>INV-3</td><td>Pre-execution admission</td></tr><tr><td><strong>G6</strong></td><td>Injection Resistance</td><td>INV-2 + Taint</td><td>Capability + taint validation</td></tr></tbody></table><hr><h2 id="iv-verification-matrix" tabindex="-1">IV. Verification Matrix <a class="header-anchor" href="#iv-verification-matrix" aria-label="Permalink to &quot;IV. Verification Matrix&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Invariant</th><th>Test Category</th><th>Pass Criteria</th><th>Test Command</th></tr></thead><tbody><tr><td><strong>INV-1</strong></td><td>Confinement</td><td>0 escape paths</td><td><code>authority test confinement</code></td></tr><tr><td><strong>INV-2</strong></td><td>Capability</td><td>0 forgeries, 0 bypasses</td><td><code>authority test capabilities</code></td></tr><tr><td><strong>INV-3</strong></td><td>Budget</td><td>0 overruns</td><td><code>authority test budgets</code></td></tr><tr><td><strong>INV-4</strong></td><td>Audit</td><td>0 undetected tampering</td><td><code>authority test audit</code></td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">Continuous Verification</p><ul><li>Every commit runs invariant tests</li><li>Every PR requires security review</li><li>Every release requires penetration test</li></ul></div><hr><h2 id="v-zero-tolerance-policies" tabindex="-1">V. Zero-Tolerance Policies <a class="header-anchor" href="#v-zero-tolerance-policies" aria-label="Permalink to &quot;V. Zero-Tolerance Policies&quot;">​</a></h2><h3 id="policy-1-no-security-todos" tabindex="-1">Policy 1: No Security TODOs <a class="header-anchor" href="#policy-1-no-security-todos" aria-label="Permalink to &quot;Policy 1: No Security TODOs&quot;">​</a></h3><p><strong>Rule</strong>: Code containing <code>TODO</code> comments on security-critical paths MUST NOT be merged.</p><p><strong>Rationale</strong>: TODOs become permanent. Security gaps are exploitable.</p><h3 id="policy-2-no-soft-failures" tabindex="-1">Policy 2: No Soft Failures <a class="header-anchor" href="#policy-2-no-soft-failures" aria-label="Permalink to &quot;Policy 2: No Soft Failures&quot;">​</a></h3><p><strong>Rule</strong>: Security checks MUST hard-fail. No &quot;log and continue&quot; on security violations.</p><p><strong>Rationale</strong>: Soft failures allow bypass. Attackers find edge cases.</p><h3 id="policy-3-no-ambient-authority" tabindex="-1">Policy 3: No Ambient Authority <a class="header-anchor" href="#policy-3-no-ambient-authority" aria-label="Permalink to &quot;Policy 3: No Ambient Authority&quot;">​</a></h3><p><strong>Rule</strong>: Every privileged operation MUST require explicit capability.</p><p><strong>Rationale</strong>: Ambient authority (implicit permissions) enables confused deputy attacks.</p><h3 id="policy-4-no-exception-paths" tabindex="-1">Policy 4: No Exception Paths <a class="header-anchor" href="#policy-4-no-exception-paths" aria-label="Permalink to &quot;Policy 4: No Exception Paths&quot;">​</a></h3><p><strong>Rule</strong>: Security validation MUST occur on ALL code paths, including error handlers.</p><p><strong>Rationale</strong>: Exception handlers are often less tested and more vulnerable.</p><h3 id="policy-5-fail-closed" tabindex="-1">Policy 5: Fail Closed <a class="header-anchor" href="#policy-5-fail-closed" aria-label="Permalink to &quot;Policy 5: Fail Closed&quot;">​</a></h3><p><strong>Rule</strong>: On any ambiguity or error in security validation, DENY.</p><p><strong>Rationale</strong>: Fail-open creates exploitable windows. Unknown = untrusted.</p><hr><h2 id="vi-incident-response" tabindex="-1">VI. Incident Response <a class="header-anchor" href="#vi-incident-response" aria-label="Permalink to &quot;VI. Incident Response&quot;">​</a></h2><h3 id="if-invariant-violation-detected" tabindex="-1">If Invariant Violation Detected <a class="header-anchor" href="#if-invariant-violation-detected" aria-label="Permalink to &quot;If Invariant Violation Detected&quot;">​</a></h3><ol><li><strong>IMMEDIATE</strong>: Halt all agent execution</li><li><strong>CONTAIN</strong>: Revoke all active capabilities</li><li><strong>INVESTIGATE</strong>: Audit log forensics</li><li><strong>REMEDIATE</strong>: Patch with invariant proof</li><li><strong>VERIFY</strong>: Full test suite before restart</li></ol><h3 id="severity-classification" tabindex="-1">Severity Classification <a class="header-anchor" href="#severity-classification" aria-label="Permalink to &quot;Severity Classification&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Severity</th><th>Definition</th><th>Response Time</th></tr></thead><tbody><tr><td><strong>P0</strong></td><td>Invariant violation in production</td><td>&lt; 1 hour</td></tr><tr><td><strong>P1</strong></td><td>Invariant violation in staging</td><td>&lt; 4 hours</td></tr><tr><td><strong>P2</strong></td><td>Test failure on invariant</td><td>&lt; 24 hours</td></tr><tr><td><strong>P3</strong></td><td>Potential invariant weakness</td><td>&lt; 1 week</td></tr></tbody></table><hr><div class="danger custom-block"><p class="custom-block-title">Security Contact</p><p>For security vulnerabilities, contact: <a href="mailto:security@nanovms.com" target="_blank" rel="noreferrer">security@nanovms.com</a> (private disclosure)</p></div><p><em>This document is normative. All Authority Kernel implementations MUST comply.</em></p>`,56))])}const f=t(d,[["render",k]]);export{v as __pageData,f as default};
