import{_ as t,c as e,o as a,ah as d}from"./chunks/framework.CI1pfr7V.js";const i=JSON.parse('{"title":"Authority Kernel (AK) Design Document","description":"","frontmatter":{},"headers":[],"relativePath":"design/ak-design.md","filePath":"design/ak-design.md","lastUpdated":1768808469000}');const s=t({name:"design/ak-design.md"},[["render",function(t,i,s,o,n,r){return a(),e("div",null,[...i[0]||(i[0]=[d('<h1 id="authority-kernel-ak-design-document" tabindex="-1">Authority Kernel (AK) Design Document <a class="header-anchor" href="#authority-kernel-ak-design-document" aria-label="Permalink to &quot;Authority Kernel (AK) Design Document&quot;">​</a></h1><p><strong>Version:</strong> 1.0 <strong>Date:</strong> 2026-01-16 <strong>Status:</strong> ACTIVE - Team Contract in Effect</p><p>This document defines the shared interfaces, hook points, and ownership boundaries for the deny-by-default Authority Kernel migration.</p><hr><h2 id="_1-architecture-overview" tabindex="-1">1. Architecture Overview <a class="header-anchor" href="#_1-architecture-overview" aria-label="Permalink to &quot;1. Architecture Overview&quot;">​</a></h2><h3 id="_1-1-core-principle-single-authority-gate" tabindex="-1">1.1 Core Principle: Single Authority Gate <a class="header-anchor" href="#_1-1-core-principle-single-authority-gate" aria-label="Permalink to &quot;1.1 Core Principle: Single Authority Gate&quot;">​</a></h3><p>All authority-bearing operations MUST flow through ONE enforcement function:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ak_authorize_and_execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ak_ctx_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                             const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ak_effect_req </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                             ak_decision </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">decision_out</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                             long</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">retval_out</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>POSIX syscalls are a <strong>compatibility frontend</strong> that translate into AK effects</li><li>Default is <strong>DENY-BY-DEFAULT</strong>: if policy cannot prove allow, deny the effect</li><li>Agentic primitives (tools, WASM, inference) are first-class effects</li></ul><h3 id="_1-2-effect-model" tabindex="-1">1.2 Effect Model <a class="header-anchor" href="#_1-2-effect-model" aria-label="Permalink to &quot;1.2 Effect Model&quot;">​</a></h3><p>Every effectful operation is expressed as an <strong>AK Effect</strong> with:</p><ul><li>Canonical target (absolute path, normalized sockaddr, tool identity)</li><li>Trace ID for correlation</li><li>Budget constraints</li><li>Policy-checkable parameters</li></ul><hr><h2 id="_2-concrete-hook-points-existing-codebase" tabindex="-1">2. Concrete Hook Points (Existing Codebase) <a class="header-anchor" href="#_2-concrete-hook-points-existing-codebase" aria-label="Permalink to &quot;2. Concrete Hook Points (Existing Codebase)&quot;">​</a></h2><h3 id="_2-1-syscall-entry-dispatcher" tabindex="-1">2.1 Syscall Entry / Dispatcher <a class="header-anchor" href="#_2-1-syscall-entry-dispatcher" aria-label="Permalink to &quot;2.1 Syscall Entry / Dispatcher&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Function</th><th>Notes</th></tr></thead><tbody><tr><td>Main POSIX dispatcher</td><td><code>src/unix/syscall.c:194</code></td><td><code>read()</code>, <code>write()</code>, etc.</td><td>Routes to fdesc operations</td></tr><tr><td>AK integration check</td><td><code>src/unix/syscall.c:6-9</code></td><td><code>#ifdef CONFIG_AK_ENABLED</code></td><td>Existing conditional include</td></tr><tr><td>AK syscall handler</td><td><code>src/agentic/ak_nanos.c:88</code></td><td><code>ak_syscall_handler()</code></td><td>Handles syscalls 1024-1100</td></tr><tr><td>AK init</td><td><code>src/agentic/ak_nanos.c:39</code></td><td><code>ak_nanos_init()</code></td><td>Called from kernel startup</td></tr><tr><td>AK dispatch</td><td><code>src/agentic/ak_syscall.c</code></td><td><code>ak_dispatch()</code></td><td>7-stage validation pipeline</td></tr></tbody></table><h3 id="_2-2-process-thread-structures" tabindex="-1">2.2 Process/Thread Structures <a class="header-anchor" href="#_2-2-process-thread-structures" aria-label="Permalink to &quot;2.2 Process/Thread Structures&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Line</th><th>Notes</th></tr></thead><tbody><tr><td>Thread struct</td><td><code>src/unix/unix_internal.h:324-376</code></td><td><code>struct thread</code></td><td>Per-thread state</td></tr><tr><td>Process forward decl</td><td><code>src/unix/unix.h</code></td><td><code>typedef struct process *process</code></td><td>Process handle</td></tr><tr><td>Agent context</td><td><code>src/agentic/ak_types.h:411-444</code></td><td><code>struct ak_agent_context</code></td><td>AK per-agent state</td></tr><tr><td>Current context</td><td><code>src/agentic/ak_nanos.c:32</code></td><td><code>__thread ak_agent_context_t *current_context</code></td><td>TLS context</td></tr></tbody></table><h3 id="_2-3-network-syscall-registration" tabindex="-1">2.3 Network Syscall Registration <a class="header-anchor" href="#_2-3-network-syscall-registration" aria-label="Permalink to &quot;2.3 Network Syscall Registration&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Function</th><th>Notes</th></tr></thead><tbody><tr><td>Socket creation</td><td><code>src/net/netsyscall.c</code></td><td>Dispatches via <code>struct sock</code></td><td>lwIP-based</td></tr><tr><td>Connect</td><td><code>src/net/netsyscall.c:125</code></td><td><code>netsock_connect()</code></td><td>TCP/UDP connect</td></tr><tr><td>Bind</td><td><code>src/net/netsyscall.c:122</code></td><td><code>netsock_bind()</code></td><td>Port binding</td></tr><tr><td>Listen</td><td><code>src/net/netsyscall.c:124</code></td><td><code>netsock_listen()</code></td><td>Server listen</td></tr><tr><td>Socket struct</td><td><code>src/net/netsyscall.c:84-107</code></td><td><code>struct netsock</code></td><td>Per-socket state</td></tr></tbody></table><h3 id="_2-4-filesystem-operations" tabindex="-1">2.4 Filesystem Operations <a class="header-anchor" href="#_2-4-filesystem-operations" aria-label="Permalink to &quot;2.4 Filesystem Operations&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Function</th><th>Notes</th></tr></thead><tbody><tr><td>Open</td><td><code>src/unix/syscall.c</code></td><td><code>open()</code>, <code>openat()</code></td><td>File descriptor creation</td></tr><tr><td>Read</td><td><code>src/unix/syscall.c:194</code></td><td><code>read()</code></td><td>Via fdesc</td></tr><tr><td>Write</td><td><code>src/unix/syscall.c</code></td><td><code>write()</code></td><td>Via fdesc</td></tr><tr><td>Unlink</td><td><code>src/fs/</code></td><td><code>unlink()</code></td><td>File deletion</td></tr><tr><td>Mkdir</td><td><code>src/fs/</code></td><td><code>mkdir()</code></td><td>Directory creation</td></tr><tr><td>Rename</td><td><code>src/fs/</code></td><td><code>rename()</code></td><td>File move</td></tr></tbody></table><h3 id="_2-5-existing-ak-syscall-base-dispatch" tabindex="-1">2.5 Existing AK Syscall Base Dispatch <a class="header-anchor" href="#_2-5-existing-ak-syscall-base-dispatch" aria-label="Permalink to &quot;2.5 Existing AK Syscall Base Dispatch&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Notes</th></tr></thead><tbody><tr><td>Syscall numbers</td><td><code>src/agentic/ak_types.h:27-60</code></td><td>1024-1037 defined</td></tr><tr><td>Handler dispatch</td><td><code>src/agentic/ak_syscall.c</code></td><td>Switch on op code</td></tr><tr><td>Heap operations</td><td><code>ak_handle_read/alloc/write/delete</code></td><td>CRUD on typed heap</td></tr><tr><td>Tool calls</td><td><code>ak_handle_call</code></td><td>AK_SYS_CALL (1028)</td></tr><tr><td>Inference</td><td><code>ak_handle_inference</code> (in ak_inference.h)</td><td>AK_SYS_INFERENCE (1037)</td></tr></tbody></table><h3 id="_2-6-policy-stubs-audit-subsystem" tabindex="-1">2.6 Policy Stubs &amp; Audit Subsystem <a class="header-anchor" href="#_2-6-policy-stubs-audit-subsystem" aria-label="Permalink to &quot;2.6 Policy Stubs &amp; Audit Subsystem&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Notes</th></tr></thead><tbody><tr><td>Policy structure</td><td><code>src/agentic/ak_policy.h:116-143</code></td><td>Budget, tool/domain rules</td></tr><tr><td>Policy load</td><td><code>src/agentic/ak_policy.c</code></td><td>JSON/YAML parsing</td></tr><tr><td>Audit log</td><td><code>src/agentic/ak_audit.h:264</code></td><td>Hash-chained entries</td></tr><tr><td>Audit append</td><td><code>ak_audit_append()</code></td><td>Synchronous fsync</td></tr><tr><td>Audit verify</td><td><code>ak_audit_verify()</code></td><td>Chain verification</td></tr></tbody></table><h3 id="_2-7-wasm-hooks-tool-registry" tabindex="-1">2.7 WASM Hooks / Tool Registry <a class="header-anchor" href="#_2-7-wasm-hooks-tool-registry" aria-label="Permalink to &quot;2.7 WASM Hooks / Tool Registry&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Notes</th></tr></thead><tbody><tr><td>Module struct</td><td><code>src/agentic/ak_wasm.h:34-74</code></td><td>Bytecode, limits, signature</td></tr><tr><td>Tool struct</td><td><code>src/agentic/ak_wasm.h:82-109</code></td><td>Named exports with caps</td></tr><tr><td>Exec context</td><td><code>src/agentic/ak_wasm.h:147-184</code></td><td>Per-invocation state</td></tr><tr><td>Host functions</td><td><code>src/agentic/ak_wasm_host.c</code></td><td>FS/NET host calls</td></tr></tbody></table><h3 id="_2-8-path-canonicalization" tabindex="-1">2.8 Path Canonicalization <a class="header-anchor" href="#_2-8-path-canonicalization" aria-label="Permalink to &quot;2.8 Path Canonicalization&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Component</th><th>File</th><th>Function</th><th>Notes</th></tr></thead><tbody><tr><td>Path sanitize</td><td><code>src/agentic/ak_sanitize.h:99</code></td><td><code>ak_sanitize_path()</code></td><td>Remove .., null bytes</td></tr><tr><td>URL sanitize</td><td><code>src/agentic/ak_sanitize.h</code></td><td><code>ak_sanitize_url()</code></td><td>URL normalization</td></tr><tr><td>Taint levels</td><td><code>src/agentic/ak_types.h:169-177</code></td><td><code>enum ak_taint</code></td><td>0=trusted, 100=untrusted</td></tr></tbody></table><hr><h2 id="_3-security-invariants" tabindex="-1">3. Security Invariants <a class="header-anchor" href="#_3-security-invariants" aria-label="Permalink to &quot;3. Security Invariants&quot;">​</a></h2><ol><li><strong>INV-DENY</strong>: Deny-by-default always active after boot</li><li><strong>INV-SINGLE</strong>: <code>ak_authorize_and_execute()</code> is the ONLY authority gate</li><li><strong>INV-CANONICAL</strong>: All targets canonicalized before policy match</li><li><strong>INV-BOUNDED</strong>: All buffers have fixed maximum sizes</li><li><strong>INV-AUDIT</strong>: Denied effects are logged (rate-limited for data-plane)</li><li><strong>INV-NO-BYPASS</strong>: Tools/WASM/Infer cannot bypass AK for FS/NET</li></ol><hr><h2 id="_4-test-requirements" tabindex="-1">4. Test Requirements <a class="header-anchor" href="#_4-test-requirements" aria-label="Permalink to &quot;4. Test Requirements&quot;">​</a></h2><h3 id="unit-tests-run-on-host" tabindex="-1">Unit Tests (run on host) <a class="header-anchor" href="#unit-tests-run-on-host" aria-label="Permalink to &quot;Unit Tests (run on host)&quot;">​</a></h3><ul><li>Pattern matching logic</li><li>JSON policy parsing</li><li>Canonicalization functions</li><li>Decision engine logic</li></ul><h3 id="integration-tests-run-in-unikernel" tabindex="-1">Integration Tests (run in unikernel) <a class="header-anchor" href="#integration-tests-run-in-unikernel" aria-label="Permalink to &quot;Integration Tests (run in unikernel)&quot;">​</a></h3><ul><li>Allow/deny with policy</li><li>Mode switching (OFF/SOFT/HARD)</li><li>Last deny retrieval</li></ul><h3 id="smoke-test" tabindex="-1">Smoke Test <a class="header-anchor" href="#smoke-test" aria-label="Permalink to &quot;Smoke Test&quot;">​</a></h3><ul><li><code>./tools/smoke.sh</code> must pass</li><li>Boots image, runs test app, verifies deny behavior</li></ul>',41)])])}]]);export{i as __pageData,s as default};
