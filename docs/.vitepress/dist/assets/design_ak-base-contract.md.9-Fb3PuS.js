import{_ as a,c as e,o as n,ah as i}from"./chunks/framework.CpSv75ol.js";const u=JSON.parse('{"title":"AK Base Contract v1","description":"","frontmatter":{},"headers":[],"relativePath":"design/ak-base-contract.md","filePath":"design/ak-base-contract.md","lastUpdated":1768808469000}'),t={name:"design/ak-base-contract.md"};function l(r,s,o,p,d,c){return n(),e("div",null,[...s[0]||(s[0]=[i(`<h1 id="ak-base-contract-v1" tabindex="-1">AK Base Contract v1 <a class="header-anchor" href="#ak-base-contract-v1" aria-label="Permalink to &quot;AK Base Contract v1&quot;">​</a></h1><p><strong>Version:</strong> 1.0 <strong>Date:</strong> 2026-01-16 <strong>Status:</strong> ACTIVE</p><p>This document defines the fundamental security contract between the Authority Kernel and applications.</p><hr><h2 id="_1-core-principle-deny-by-default" tabindex="-1">1. Core Principle: Deny-by-Default <a class="header-anchor" href="#_1-core-principle-deny-by-default" aria-label="Permalink to &quot;1. Core Principle: Deny-by-Default&quot;">​</a></h2><p>The Authority Kernel operates on a <strong>deny-by-default</strong> principle:</p><blockquote><p>If policy cannot prove an operation is allowed, it is denied.</p></blockquote><p>There are NO implicit permissions. Every effectful operation requires explicit policy authorization.</p><hr><h2 id="_2-boot-capsule-mechanism" tabindex="-1">2. Boot Capsule Mechanism <a class="header-anchor" href="#_2-boot-capsule-mechanism" aria-label="Permalink to &quot;2. Boot Capsule Mechanism&quot;">​</a></h2><h3 id="_2-1-problem-statement" tabindex="-1">2.1 Problem Statement <a class="header-anchor" href="#_2-1-problem-statement" aria-label="Permalink to &quot;2.1 Problem Statement&quot;">​</a></h3><p>Deny-by-default creates a chicken-and-egg problem:</p><ul><li>Policy must be loaded before user processes start</li><li>But loading policy requires file access</li><li>File access requires policy permission</li></ul><h3 id="_2-2-solution-pre-user-policy-load-option-a" tabindex="-1">2.2 Solution: Pre-User Policy Load (Option A) <a class="header-anchor" href="#_2-2-solution-pre-user-policy-load-option-a" aria-label="Permalink to &quot;2.2 Solution: Pre-User Policy Load (Option A)&quot;">​</a></h3><p>The Authority Kernel uses <strong>Option A: Pre-User Policy Load</strong>:</p><ol><li>Kernel boots with minimal internal capabilities</li><li><strong>Before</strong> any user process starts: <ul><li>Kernel reads policy from initrd <code>/ak/policy.json</code></li><li>Only kernel-internal reads are allowed</li><li>No user code executes during this phase</li></ul></li><li>Policy is validated and installed</li><li>User process starts with policy already active</li><li>No &quot;boot capsule&quot; capability needs to be dropped</li></ol><h3 id="_2-3-policy-load-order" tabindex="-1">2.3 Policy Load Order <a class="header-anchor" href="#_2-3-policy-load-order" aria-label="Permalink to &quot;2.3 Policy Load Order&quot;">​</a></h3><ol><li><strong>Embedded Policy</strong> (compile-time): If <code>CONFIG_AK_EMBEDDED_POLICY</code> is set, use embedded policy blob</li><li><strong>Initrd Policy</strong>: Read <code>/ak/policy.json</code> from initrd</li><li><strong>Fail Closed</strong>: If no policy found: <ul><li>Deny all operations</li><li>Print clear console message with expected location</li><li>Do NOT start user process</li></ul></li></ol><hr><h2 id="_3-effect-categories" tabindex="-1">3. Effect Categories <a class="header-anchor" href="#_3-effect-categories" aria-label="Permalink to &quot;3. Effect Categories&quot;">​</a></h2><p>All effectful operations are categorized:</p><h3 id="_3-1-filesystem-effects" tabindex="-1">3.1 Filesystem Effects <a class="header-anchor" href="#_3-1-filesystem-effects" aria-label="Permalink to &quot;3.1 Filesystem Effects&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Effect</th><th>Description</th><th>Required Cap</th></tr></thead><tbody><tr><td><code>AK_E_FS_OPEN</code></td><td>Open file for read/write</td><td><code>fs.read</code> or <code>fs.write</code></td></tr><tr><td><code>AK_E_FS_UNLINK</code></td><td>Delete file</td><td><code>fs.write</code></td></tr><tr><td><code>AK_E_FS_RENAME</code></td><td>Rename/move file</td><td><code>fs.write</code></td></tr><tr><td><code>AK_E_FS_MKDIR</code></td><td>Create directory</td><td><code>fs.write</code></td></tr></tbody></table><h3 id="_3-2-network-effects" tabindex="-1">3.2 Network Effects <a class="header-anchor" href="#_3-2-network-effects" aria-label="Permalink to &quot;3.2 Network Effects&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Effect</th><th>Description</th><th>Required Cap</th></tr></thead><tbody><tr><td><code>AK_E_NET_CONNECT</code></td><td>Outbound connection</td><td><code>net.connect</code></td></tr><tr><td><code>AK_E_NET_DNS_RESOLVE</code></td><td>DNS resolution</td><td><code>net.dns</code></td></tr><tr><td><code>AK_E_NET_BIND</code></td><td>Bind to port</td><td><code>net.bind</code></td></tr><tr><td><code>AK_E_NET_LISTEN</code></td><td>Listen for connections</td><td><code>net.listen</code></td></tr></tbody></table><h3 id="_3-3-agentic-effects" tabindex="-1">3.3 Agentic Effects <a class="header-anchor" href="#_3-3-agentic-effects" aria-label="Permalink to &quot;3.3 Agentic Effects&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Effect</th><th>Description</th><th>Required Cap</th></tr></thead><tbody><tr><td><code>AK_E_TOOL_CALL</code></td><td>Execute tool</td><td><code>tools.call</code></td></tr><tr><td><code>AK_E_WASM_INVOKE</code></td><td>Run WASM module</td><td><code>wasm.invoke</code></td></tr><tr><td><code>AK_E_INFER</code></td><td>LLM inference</td><td><code>infer.model</code></td></tr></tbody></table><hr><h2 id="_4-deny-response-contract" tabindex="-1">4. Deny Response Contract <a class="header-anchor" href="#_4-deny-response-contract" aria-label="Permalink to &quot;4. Deny Response Contract&quot;">​</a></h2><p>When an operation is denied, the Authority Kernel provides:</p><h3 id="_4-1-immediate-response" tabindex="-1">4.1 Immediate Response <a class="header-anchor" href="#_4-1-immediate-response" aria-label="Permalink to &quot;4.1 Immediate Response&quot;">​</a></h3><ul><li><strong>errno</strong>: Appropriate POSIX error code (<code>EACCES</code>, <code>EPERM</code>, <code>ECONNREFUSED</code>)</li><li><strong>Rate-limited log</strong>: One-line denial message</li></ul><h3 id="_4-2-last-deny-information" tabindex="-1">4.2 Last Deny Information <a class="header-anchor" href="#_4-2-last-deny-information" aria-label="Permalink to &quot;4.2 Last Deny Information&quot;">​</a></h3><p>Available via <code>AK_SYS_LAST_ERROR</code>:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ak_last_deny {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ak_effect_op_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           // What was attempted</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">512</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Canonical target</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> missing_cap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // What capability was missing</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> suggested_snippet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">512</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // Copy-paste policy fix</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 trace_id;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // For correlation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errno_equiv;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             // POSIX errno</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 timestamp_ns;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // When denied</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-3-suggested-snippet-format" tabindex="-1">4.3 Suggested Snippet Format <a class="header-anchor" href="#_4-3-suggested-snippet-format" aria-label="Permalink to &quot;4.3 Suggested Snippet Format&quot;">​</a></h3><p>For file access denial:</p><div class="language-toml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add to ak.toml [fs] section:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">read = [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/path/to/denied/file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>For network denial:</p><div class="language-toml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add to ak.toml [net] section:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">connect = [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dns:example.com:443&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr><h2 id="_5-audit-contract" tabindex="-1">5. Audit Contract <a class="header-anchor" href="#_5-audit-contract" aria-label="Permalink to &quot;5. Audit Contract&quot;">​</a></h2><h3 id="_5-1-control-plane-events" tabindex="-1">5.1 Control-Plane Events <a class="header-anchor" href="#_5-1-control-plane-events" aria-label="Permalink to &quot;5.1 Control-Plane Events&quot;">​</a></h3><p>Synchronous logging for:</p><ul><li>Policy changes</li><li>Tool calls</li><li>WASM invocations</li><li>Inference requests</li></ul><h3 id="_5-2-data-plane-events" tabindex="-1">5.2 Data-Plane Events <a class="header-anchor" href="#_5-2-data-plane-events" aria-label="Permalink to &quot;5.2 Data-Plane Events&quot;">​</a></h3><p>Bounded ring buffer for:</p><ul><li>File opens</li><li>Network connections</li><li>Rate-limited (no per-event fsync)</li></ul><h3 id="_5-3-audit-entry-format" tabindex="-1">5.3 Audit Entry Format <a class="header-anchor" href="#_5-3-audit-entry-format" aria-label="Permalink to &quot;5.3 Audit Entry Format&quot;">​</a></h3><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ak_audit_entry {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 timestamp_ns;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 trace_id;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ak_effect_op_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boolean allowed;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h2 id="_6-integration-test-requirements" tabindex="-1">6. Integration Test Requirements <a class="header-anchor" href="#_6-integration-test-requirements" aria-label="Permalink to &quot;6. Integration Test Requirements&quot;">​</a></h2><p>The following tests MUST pass for the base contract:</p><h3 id="_6-1-deny-by-default-test" tabindex="-1">6.1 Deny-by-Default Test <a class="header-anchor" href="#_6-1-deny-by-default-test" aria-label="Permalink to &quot;6.1 Deny-by-Default Test&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GIVEN: Minimal policy (empty fs/net sections)</span></span>
<span class="line"><span>WHEN: Application attempts file open</span></span>
<span class="line"><span>THEN:</span></span>
<span class="line"><span>  - Operation denied with EACCES</span></span>
<span class="line"><span>  - last_deny populated with:</span></span>
<span class="line"><span>    - op = AK_E_FS_OPEN</span></span>
<span class="line"><span>    - target = canonical path</span></span>
<span class="line"><span>    - missing_cap = &quot;fs.read&quot;</span></span>
<span class="line"><span>    - suggested_snippet = valid TOML</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_6-2-allow-test" tabindex="-1">6.2 Allow Test <a class="header-anchor" href="#_6-2-allow-test" aria-label="Permalink to &quot;6.2 Allow Test&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GIVEN: Policy with fs.read = [&quot;/allowed/**&quot;]</span></span>
<span class="line"><span>WHEN: Application opens /allowed/file.txt</span></span>
<span class="line"><span>THEN:</span></span>
<span class="line"><span>  - Operation succeeds</span></span>
<span class="line"><span>  - File descriptor returned</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_6-3-network-dns-test" tabindex="-1">6.3 Network DNS Test <a class="header-anchor" href="#_6-3-network-dns-test" aria-label="Permalink to &quot;6.3 Network DNS Test&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GIVEN: Policy with net.dns = [&quot;example.com&quot;]</span></span>
<span class="line"><span>WHEN: Application resolves example.com</span></span>
<span class="line"><span>THEN: Resolution succeeds</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WHEN: Application resolves other.com</span></span>
<span class="line"><span>THEN:</span></span>
<span class="line"><span>  - Resolution denied</span></span>
<span class="line"><span>  - last_deny shows net.dns missing</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr><h2 id="_7-version-history" tabindex="-1">7. Version History <a class="header-anchor" href="#_7-version-history" aria-label="Permalink to &quot;7. Version History&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Version</th><th>Date</th><th>Changes</th></tr></thead><tbody><tr><td>1.0</td><td>2026-01-16</td><td>Initial version</td></tr></tbody></table>`,62)])])}const k=a(t,[["render",l]]);export{u as __pageData,k as default};
