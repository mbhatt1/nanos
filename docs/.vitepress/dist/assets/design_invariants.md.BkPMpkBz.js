import{_ as s,c as i,o as n,ag as e}from"./chunks/framework.bCALENAD.js";const u=JSON.parse('{"title":"Security Invariants","description":"","frontmatter":{},"headers":[],"relativePath":"design/invariants.md","filePath":"design/invariants.md","lastUpdated":1768808469000}'),t={name:"design/invariants.md"};function l(r,a,p,h,o,d){return n(),i("div",null,[...a[0]||(a[0]=[e(`<h1 id="security-invariants" tabindex="-1">Security Invariants <a class="header-anchor" href="#security-invariants" aria-label="Permalink to &quot;Security Invariants&quot;">​</a></h1><p>The Authority Kernel enforces <strong>four mathematical security invariants</strong>. These are not guidelines or best practices - they are cryptographic and architectural guarantees.</p><hr><h2 id="inv-1-no-bypass-invariant" tabindex="-1">INV-1: No-Bypass Invariant <a class="header-anchor" href="#inv-1-no-bypass-invariant" aria-label="Permalink to &quot;INV-1: No-Bypass Invariant&quot;">​</a></h2><p><strong>Statement:</strong> All external effects occur through kernel-mediated syscalls.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>For all agents A, for all IO operations O:</span></span>
<span class="line"><span>    O is external =&gt; O passes through kernel syscall interface</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="enforcement" tabindex="-1">Enforcement <a class="header-anchor" href="#enforcement" aria-label="Permalink to &quot;Enforcement&quot;">​</a></h3><ul><li>Unikernel architecture eliminates bypass vectors</li><li>No raw sockets, no direct hardware access</li><li>No process escape</li><li>All FS/NET operations routed through AK effects</li></ul><h3 id="verification" tabindex="-1">Verification <a class="header-anchor" href="#verification" aria-label="Permalink to &quot;Verification&quot;">​</a></h3><ul><li>Static analysis: No effectful paths that skip mediation</li><li>Runtime: Mode=HARD denies raw effectful syscalls</li></ul><hr><h2 id="inv-2-capability-invariant" tabindex="-1">INV-2: Capability Invariant <a class="header-anchor" href="#inv-2-capability-invariant" aria-label="Permalink to &quot;INV-2: Capability Invariant&quot;">​</a></h2><p><strong>Statement:</strong> Every effectful syscall requires a valid, non-revoked capability whose scope subsumes the request.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>For all syscalls S where effect(S) = true:</span></span>
<span class="line"><span>    exists capability C such that:</span></span>
<span class="line"><span>        valid(C) AND NOT revoked(C) AND scope(C) contains resource(S)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="validation-requirements" tabindex="-1">Validation Requirements <a class="header-anchor" href="#validation-requirements" aria-label="Permalink to &quot;Validation Requirements&quot;">​</a></h3><ul><li>HMAC-SHA256 signature verification (constant-time)</li><li>Token ID not in revocation set</li><li>Resource pattern matches request target</li><li>TTL not expired</li><li>Rate limit not exceeded</li><li>Run ID matches current execution</li></ul><h3 id="error-codes" tabindex="-1">Error Codes <a class="header-anchor" href="#error-codes" aria-label="Permalink to &quot;Error Codes&quot;">​</a></h3><ul><li><code>AK_E_CAP_INVALID</code>: Signature verification failed</li><li><code>AK_E_CAP_EXPIRED</code>: TTL exceeded</li><li><code>AK_E_CAP_REVOKED</code>: Token in revocation set</li><li><code>AK_E_CAP_SCOPE</code>: Resource/method mismatch</li><li><code>AK_E_CAP_RUN_ID</code>: Run ID mismatch</li><li><code>AK_E_CAP_RATE</code>: Rate limit exceeded</li></ul><hr><h2 id="inv-3-budget-invariant" tabindex="-1">INV-3: Budget Invariant <a class="header-anchor" href="#inv-3-budget-invariant" aria-label="Permalink to &quot;INV-3: Budget Invariant&quot;">​</a></h2><p><strong>Statement:</strong> Resource consumption never exceeds declared budgets.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>For all operations O with cost c:</span></span>
<span class="line"><span>    let current = sum of completed costs</span></span>
<span class="line"><span>    let budget = declared limit</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    PRE:  current + c &lt;= budget</span></span>
<span class="line"><span>    POST: current&#39; = current + c</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    If PRE fails: reject with E_BUDGET_EXCEEDED</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="budget-dimensions" tabindex="-1">Budget Dimensions <a class="header-anchor" href="#budget-dimensions" aria-label="Permalink to &quot;Budget Dimensions&quot;">​</a></h3><ul><li>LLM tokens (input/output)</li><li>Tool calls</li><li>Wall time (ms)</li><li>Heap objects</li><li>File I/O (bytes)</li><li>Network I/O (bytes)</li></ul><h3 id="admission-control" tabindex="-1">Admission Control <a class="header-anchor" href="#admission-control" aria-label="Permalink to &quot;Admission Control&quot;">​</a></h3><p>Every expensive operation requires a PRE-ADMISSION budget check:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s64 </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ak_budget_reserve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ak_budget_tracker_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tracker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                      ak_resource_type_t</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                      u64 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>If PRE fails, the operation is denied before any state change.</p><hr><h2 id="inv-4-log-commitment-invariant" tabindex="-1">INV-4: Log Commitment Invariant <a class="header-anchor" href="#inv-4-log-commitment-invariant" aria-label="Permalink to &quot;INV-4: Log Commitment Invariant&quot;">​</a></h2><p><strong>Statement:</strong> Every state transition appends a hash-chained audit entry.</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>For all state transitions from S to S&#39;:</span></span>
<span class="line"><span>    exists log entry E such that:</span></span>
<span class="line"><span>        E.prev_hash = hash(log[n-1])</span></span>
<span class="line"><span>        E.this_hash = SHA256(E.prev_hash || canonical(E))</span></span>
<span class="line"><span>        log&#39; = log ++ [E]</span></span>
<span class="line"><span>        Response sent only after fsync(log)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="hash-chain-structure" tabindex="-1">Hash Chain Structure <a class="header-anchor" href="#hash-chain-structure" aria-label="Permalink to &quot;Hash Chain Structure&quot;">​</a></h3><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Entry[0]: prev_hash = zeros, this_hash = SHA256(zeros || E0)</span></span>
<span class="line"><span>Entry[n]: prev_hash = Entry[n-1].this_hash</span></span>
<span class="line"><span>          this_hash = SHA256(prev_hash || canonical(En))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="properties" tabindex="-1">Properties <a class="header-anchor" href="#properties" aria-label="Permalink to &quot;Properties&quot;">​</a></h3><ul><li><strong>Append-only</strong>: No deletions, no modifications</li><li><strong>Tamper-evident</strong>: Broken chain detected immediately</li><li><strong>Non-repudiation</strong>: Request hash proves agent action</li></ul><h3 id="verification-1" tabindex="-1">Verification <a class="header-anchor" href="#verification-1" aria-label="Permalink to &quot;Verification&quot;">​</a></h3><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ak_audit_verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(u64 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">from_seq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, u64 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">to_seq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Walks the chain from Entry[from_seq] to Entry[to_seq], computing hashes and verifying the chain.</p><hr><h2 id="audit-log-entry-format" tabindex="-1">Audit Log Entry Format <a class="header-anchor" href="#audit-log-entry-format" aria-label="Permalink to &quot;Audit Log Entry Format&quot;">​</a></h2><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ak_audit_entry {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 seq;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Monotonic sequence number</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               // Agent ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">run_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Execution ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u16 op;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   // Operation code</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 timestamp_ns;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // Nanosecond timestamp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // SHA-256(request)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // SHA-256(response)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prev_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // Previous entry hash</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">this_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // SHA-256(prev_hash || entry)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h2 id="anchoring-optional" tabindex="-1">Anchoring (Optional) <a class="header-anchor" href="#anchoring-optional" aria-label="Permalink to &quot;Anchoring (Optional)&quot;">​</a></h2><p>For efficient verification over large ranges, periodic anchors are optional:</p><div class="language-c vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ak_audit_anchor {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 seq;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  // Anchor sequence</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u8 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">merkle_root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       // Merkle root of entries</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    u64 timestamp_ns;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>An anchor at sequence N certifies all entries from the previous anchor to N.</p><hr><h2 id="invariant-enforcement-points" tabindex="-1">Invariant Enforcement Points <a class="header-anchor" href="#invariant-enforcement-points" aria-label="Permalink to &quot;Invariant Enforcement Points&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Invariant</th><th>Enforcement Point</th><th>Function</th></tr></thead><tbody><tr><td>INV-1</td><td>Syscall dispatcher</td><td><code>ak_syscall_handler()</code></td></tr><tr><td>INV-2</td><td>Authorization gate</td><td><code>ak_authorize_and_execute()</code></td></tr><tr><td>INV-3</td><td>Admission control</td><td><code>ak_budget_reserve()</code></td></tr><tr><td>INV-4</td><td>Audit append</td><td><code>ak_audit_append()</code></td></tr></tbody></table><hr><h2 id="p0-p1-p2-roadmap" tabindex="-1">P0/P1/P2 Roadmap <a class="header-anchor" href="#p0-p1-p2-roadmap" aria-label="Permalink to &quot;P0/P1/P2 Roadmap&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Phase</th><th>INV-1</th><th>INV-2</th><th>INV-3</th><th>INV-4</th></tr></thead><tbody><tr><td><strong>P0</strong></td><td>Core</td><td>Policy-gated</td><td>Token budgets</td><td>Ring buffer</td></tr><tr><td><strong>P1</strong></td><td>Complete</td><td>Revocation</td><td>All budgets</td><td>Persistent log</td></tr><tr><td><strong>P2</strong></td><td>Hardened</td><td>Delegation</td><td>Fine-grained</td><td>External anchoring</td></tr></tbody></table><hr><h2 id="testing-the-invariants" tabindex="-1">Testing the Invariants <a class="header-anchor" href="#testing-the-invariants" aria-label="Permalink to &quot;Testing the Invariants&quot;">​</a></h2><h3 id="unit-tests" tabindex="-1">Unit Tests <a class="header-anchor" href="#unit-tests" aria-label="Permalink to &quot;Unit Tests&quot;">​</a></h3><ul><li>Capability verification with invalid inputs</li><li>Hash chain verification</li><li>Budget admission tests</li><li>Syscall routing verification</li></ul><h3 id="integration-tests" tabindex="-1">Integration Tests <a class="header-anchor" href="#integration-tests" aria-label="Permalink to &quot;Integration Tests&quot;">​</a></h3><ul><li>Deny-by-default with missing policy</li><li>Allow operations with valid policy</li><li>Budget exhaustion prevents operation</li><li>Audit log integrity across agent restarts</li></ul><h3 id="security-tests" tabindex="-1">Security Tests <a class="header-anchor" href="#security-tests" aria-label="Permalink to &quot;Security Tests&quot;">​</a></h3><ul><li>Capability forgery detection</li><li>Policy bypass attempts</li><li>Audit log tampering detection</li><li>TOCTOU attacks on resource validation</li></ul><hr><h2 id="violation-response" tabindex="-1">Violation Response <a class="header-anchor" href="#violation-response" aria-label="Permalink to &quot;Violation Response&quot;">​</a></h2><p>If an invariant violation is detected:</p><ol><li><strong>Halt agent execution</strong> - Stop processing immediately</li><li><strong>Revoke all active capabilities</strong> - Prevent further operations</li><li><strong>Preserve audit log</strong> - Keep log for forensics</li><li><strong>Patch and verify</strong> - Fix the issue and test thoroughly before restart</li></ol><p>Severity levels:</p><table tabindex="0"><thead><tr><th>Level</th><th>Definition</th><th>Response</th></tr></thead><tbody><tr><td>P0</td><td>Invariant violation in production</td><td>Immediate</td></tr><tr><td>P1</td><td>Invariant violation in staging</td><td>4 hours</td></tr><tr><td>P2</td><td>Test failure on invariant</td><td>24 hours</td></tr></tbody></table><hr><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><ul><li><a href="./ak-design">Authority Kernel Design</a></li><li><a href="./ak-base-contract">Base Contract</a></li><li><a href="./ak-threat-model">Threat Model</a></li></ul>`,70)])])}const k=s(t,[["render",l]]);export{u as __pageData,k as default};
