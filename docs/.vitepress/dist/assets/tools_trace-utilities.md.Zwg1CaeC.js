import{_ as s,c as e,o as i,ag as n}from"./chunks/framework.bCALENAD.js";const u=JSON.parse('{"title":"Trace Utilities","description":"","frontmatter":{},"headers":[],"relativePath":"tools/trace-utilities.md","filePath":"tools/trace-utilities.md","lastUpdated":1768808469000}'),t={name:"tools/trace-utilities.md"};function l(r,a,p,o,c,h){return i(),e("div",null,[...a[0]||(a[0]=[n(`<h1 id="trace-utilities" tabindex="-1">Trace Utilities <a class="header-anchor" href="#trace-utilities" aria-label="Permalink to &quot;Trace Utilities&quot;">​</a></h1><p>This page documents the kernel tracing and analysis tools for Authority Nanos.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Authority Nanos implements a tracing mechanism inspired by <a href="https://www.kernel.org/doc/Documentation/trace/ftrace.txt" target="_blank" rel="noreferrer">Linux&#39; ftrace</a>. Trace utilities help you analyze kernel behavior and identify performance bottlenecks.</p><h2 id="enabling-tracing" tabindex="-1">Enabling Tracing <a class="header-anchor" href="#enabling-tracing" aria-label="Permalink to &quot;Enabling Tracing&quot;">​</a></h2><p>To enable tracing, build nanos by specifying <code>TRACE=ftrace</code>:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRACE=ftrace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TARGET=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">targe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>The resulting kernel will collect timing data on all kernel function calls.</p><h2 id="collecting-trace-data" tabindex="-1">Collecting Trace Data <a class="header-anchor" href="#collecting-trace-data" aria-label="Permalink to &quot;Collecting Trace Data&quot;">​</a></h2><p>Once your application is running, access trace data via HTTP:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost:9090/ftrace/trace</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>This creates a <code>trace</code> file that looks like:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># tracer: function_graph</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span># CPU  DURATION                  FUNCTION CALLS</span></span>
<span class="line"><span># |     |   |                     |   |   |   |</span></span>
<span class="line"><span> 0)               |  mcache_alloc() {</span></span>
<span class="line"><span> 0) ! 207.666 us  |    runtime_memcpy();</span></span>
<span class="line"><span> 0)   0.071 us    |    runtime_memcpy();</span></span>
<span class="line"><span> 0)   0.077 us    |    objcache_allocate();</span></span>
<span class="line"><span> 0) ! 208.173 us  |  }</span></span>
<span class="line"><span> 0)   0.093 us    |  install_fallback_fault_handler();</span></span>
<span class="line"><span> ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="trace-options" tabindex="-1">Trace Options <a class="header-anchor" href="#trace-options" aria-label="Permalink to &quot;Trace Options&quot;">​</a></h2><h3 id="tracer-selection" tabindex="-1">Tracer Selection <a class="header-anchor" href="#tracer-selection" aria-label="Permalink to &quot;Tracer Selection&quot;">​</a></h3><h4 id="function-graph" tabindex="-1">function_graph <a class="header-anchor" href="#function-graph" aria-label="Permalink to &quot;function_graph&quot;">​</a></h4><p>The function_graph tracer interposes all function entries and return paths, allowing the kernel to collect entry and exit times for all function calls. This is the default tracer and creates trace files with entry/exit timing.</p><h4 id="function" tabindex="-1">function <a class="header-anchor" href="#function" aria-label="Permalink to &quot;function&quot;">​</a></h4><p>The function tracer only interposes function entries. It creates less overhead but provides less detailed timing information.</p><h3 id="trace-data-consumption" tabindex="-1">Trace Data Consumption <a class="header-anchor" href="#trace-data-consumption" aria-label="Permalink to &quot;Trace Data Consumption&quot;">​</a></h3><p>Trace data is stored in an in-memory ring buffer (64MB by default). Once full, subsequent function calls are not traced.</p><p><strong>Destructive query</strong> (removes data from buffer):</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost:9090/ftrace/trace_pipe</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>Non-destructive query</strong> (keeps data in buffer):</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost:9090/ftrace/trace</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="trace-parsing-tools" tabindex="-1">Trace Parsing Tools <a class="header-anchor" href="#trace-parsing-tools" aria-label="Permalink to &quot;Trace Parsing Tools&quot;">​</a></h2><h3 id="parse-trace-py" tabindex="-1">parse-trace.py <a class="header-anchor" href="#parse-trace-py" aria-label="Permalink to &quot;parse-trace.py&quot;">​</a></h3><p>Parses function_graph trace files and generates CSV:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./tools/trace-utilities/parse-trace.py</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">trace_fil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Output: <code>trace.csv</code></p><h3 id="runtime-breakdown-py" tabindex="-1">runtime-breakdown.py <a class="header-anchor" href="#runtime-breakdown-py" aria-label="Permalink to &quot;runtime-breakdown.py&quot;">​</a></h3><p>Generates a bar graph showing function latencies:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./tools/trace-utilities/runtime-breakdown.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trace.csv</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Requirements: <code>pandas</code> and <code>plotly</code> Python packages</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pandas</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> plotly</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Output: Interactive HTML graph showing:</p><ul><li>Function self-time (function time minus called functions)</li><li>Total time per function across all invocations</li><li>Toggleable function filtering</li></ul><h2 id="workflow-example" tabindex="-1">Workflow Example <a class="header-anchor" href="#workflow-example" aria-label="Permalink to &quot;Workflow Example&quot;">​</a></h2><ol><li><p><strong>Build with tracing:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TRACE=ftrace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TARGET=myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p><strong>Collect trace data:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost:9090/ftrace/trace</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p><strong>Parse trace:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./tools/trace-utilities/parse-trace.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trace</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p><strong>Analyze results:</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./tools/trace-utilities/runtime-breakdown.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> trace.csv</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p><strong>View graph</strong> in your default browser</p></li></ol><h2 id="performance-considerations" tabindex="-1">Performance Considerations <a class="header-anchor" href="#performance-considerations" aria-label="Permalink to &quot;Performance Considerations&quot;">​</a></h2><ul><li><strong>Ring buffer size</strong>: Default 64MB, fills quickly with many functions</li><li><strong>Overhead</strong>: function_graph adds measurable overhead to all function calls</li><li><strong>Use cases</strong>: Identify bottlenecks, understand call patterns, debug timing issues</li></ul><h2 id="tips" tabindex="-1">Tips <a class="header-anchor" href="#tips" aria-label="Permalink to &quot;Tips&quot;">​</a></h2><ul><li>Use <code>trace_pipe</code> to stream data and avoid buffer overflow</li><li>Focus on specific functions by filtering in the parsing scripts</li><li>Compare before/after traces to measure optimization impact</li><li>Disable tracing for production builds</li></ul><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to &quot;References&quot;">​</a></h2><ul><li><a href="/testing/">Testing Documentation</a> - Other debugging tools</li><li><a href="https://nanovms.gitbook.io/ops/" target="_blank" rel="noreferrer">Nanos Documentation</a></li></ul>`,45)])])}const b=s(t,[["render",l]]);export{u as __pageData,b as default};
