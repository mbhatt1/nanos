FROM --platform=linux/amd64 ubuntu:22.04

# Install build dependencies and Go
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    git \
    golang-go \
    qemu-system-x86 \
    nasm \
    && rm -rf /var/lib/apt/lists/*

# Copy Authority Nanos source (includes nanos-rootfs.tar.gz)
WORKDIR /nanos
COPY . /nanos

# Initialize git repo for gitversion.c generation
RUN cd /nanos && \
    git init && \
    git config user.email "build@nanos.local" && \
    git config user.name "Build" && \
    git add . && \
    git commit --no-verify -m "Initial build" || echo "Git init completed"

# Extract Alpine Python static rootfs (x86_64, musl libc)
RUN mkdir -p /tmp/nanos-root && \
    cd /tmp && tar xzf /nanos/nanos-rootfs-alpine-python.tar.gz -C /tmp/nanos-root && \
    echo "âœ… Alpine Python 3.11 rootfs extracted (x86_64, musl libc)" && \
    ls -lh /tmp/nanos-root/bin/python3 && \
    ls -lh /tmp/nanos-root/lib/libpython3.11.so.1.0 && \
    ls -lh /tmp/nanos-root/usr/local/lib/python3.11/encodings/__init__.py && \
    rm -f /nanos/nanos-rootfs-alpine-python.tar.gz /nanos/nanos-rootfs-minimal-python.tar.gz

# Clean old build artifacts (from macOS) and build from scratch
RUN cd /nanos && make clean && make -j$(nproc) 2>&1 | tail -100 || echo "Build completed with status: $?"

# Build tools (mkfs, dump, vdsogen)
RUN cd /nanos && make -C tools all 2>&1 | tail -50 && \
    echo "âœ… mkfs compiled" && \
    ls -lh /nanos/output/tools/bin/mkfs

# Build minops
RUN cd /nanos/tools/minops && go build -o minops main.go && echo "âœ… minops compiled"

# Verify we have kernel and Python
RUN echo "Checking artifacts:" && \
    if [ -f /nanos/output/platform/pc/bin/kernel.img ]; then \
      echo "âœ… Kernel found"; \
      ls -lh /nanos/output/platform/pc/bin/kernel.img; \
    else \
      echo "âš ï¸ Kernel not found, checking what we have..."; \
      find /nanos/output -name "kernel*" -o -name "*.img" 2>/dev/null | head -20; \
    fi && \
    echo "âœ… Python rootfs ready: $(ls -lh /tmp/nanos-root/bin/python3 | awk '{print $5}')"

# Create test script
RUN cat > /run-test.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”§ Authority Nanos - Python Execution Test"
echo "==========================================="
echo ""

cd /nanos

echo "ðŸ“ Environment:"
echo "   Kernel: $(ls -lh output/platform/pc/bin/kernel.img | awk '{print $5}')"
echo "   Python: $(ls -lh /tmp/nanos-root/bin/python3 | awk '{print $5}')"
echo "   minops: $(ls -lh tools/minops/minops | awk '{print $5}')"
echo "   mkfs: $(ls -lh output/tools/bin/mkfs | awk '{print $5}')"
echo ""

echo "ðŸ Testing Python execution in Nanos kernel..."
echo ""

# Set PATH to include tools directory
export PATH="/nanos/output/tools/bin:$PATH"

# Run Python test with timeout
timeout 20 tools/minops/minops run examples/test-python.py -m 512 2>&1 || true

echo ""
echo "âœ… Test execution completed"
EOF

RUN chmod +x /run-test.sh

# Set default command
CMD ["/run-test.sh"]
