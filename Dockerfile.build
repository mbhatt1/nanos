FROM --platform=linux/amd64 ubuntu:22.04 AS builder

# Install build dependencies and Go
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    wget \
    git \
    golang-go \
    qemu-system-x86 \
    nasm \
    && rm -rf /var/lib/apt/lists/*

# Copy Authority Nanos source
WORKDIR /nanos
COPY . /nanos

# Initialize git repo for gitversion.c generation
RUN cd /nanos && \
    git init && \
    git config user.email "build@nanos.local" && \
    git config user.name "Build" && \
    git add . && \
    git commit --no-verify -m "Initial build" || echo "Git init completed"

# Clean old build artifacts and build from scratch
RUN cd /nanos && make clean && make -j$(nproc) 2>&1 | tail -100 || echo "Build completed with status: $?"

# Build tools (mkfs, dump, vdsogen)
RUN cd /nanos && make -C tools all 2>&1 | tail -50 && \
    echo "âœ… mkfs compiled" && \
    ls -lh /nanos/output/tools/bin/mkfs

# Build minops
RUN cd /nanos/tools/minops && go build -o minops main.go && echo "âœ… minops compiled"

# ============================================================================
# Extract Alpine Linux filesystem for Nanos rootfs
# ============================================================================
FROM --platform=linux/amd64 alpine:3.19 AS alpine-rootfs

# Install Python, build tools, CA certs, and pip packages for LangChain/CrewAI support
RUN apk add --no-cache python3 py3-pip build-base ca-certificates && \
    echo "âœ… Alpine Linux with Python 3.11, pip, and CA certificates ready"

# Install LangChain, CrewAI, and dependencies via pip
# Using --target to install to a specific directory for easy copying
RUN pip3 install --no-cache-dir --target=/pip-packages \
    requests \
    httpx \
    pydantic \
    openai \
    anthropic \
    langchain-core \
    langchain-openai \
    langchain-anthropic \
    langchain-community \
    crewai \
    2>&1 | tail -20 || echo "âš ï¸ Some packages may have failed - continuing with available packages" && \
    echo "âœ… Pip packages installed" && \
    ls /pip-packages/ | head -20

# Copy libak source from builder and compile with musl
COPY --from=builder /nanos/src/agentic/libak.c /tmp/libak.c
COPY --from=builder /nanos/src/agentic/libak.h /tmp/libak.h
RUN cd /tmp && \
    gcc -shared -fPIC -o libak.so libak.c -DLIBAK_STANDALONE && \
    echo "âœ… libak.so built with musl" && \
    ls -lh /tmp/libak.so

# Copy Alpine filesystem and restructure for Nanos
RUN mkdir -p /rootfs && \
    for dir in bin sbin lib lib64 usr etc home opt root srv var boot media mnt tmp; do \
      if [ -d /$dir ]; then \
        cp -r /$dir /rootfs/; \
      fi; \
    done && \
    mkdir -p /rootfs/proc /rootfs/sys /rootfs/dev && \
    # Copy musl-built libak.so to rootfs
    cp /tmp/libak.so /rootfs/lib/ && \
    echo "âœ… Rootfs prepared with musl libak.so" && \
    ls -lah /rootfs/usr/bin/python* && \
    ls -lah /rootfs/lib/libak.so && \
    # Copy Python to both /bin and /usr/bin for compatibility
    cp /rootfs/usr/bin/python3.11 /rootfs/bin/python3.11 && \
    ln -sf python3.11 /rootfs/bin/python3 && \
    echo "âœ… Python symlinked to /bin/python3" && \
    # Ensure CA certificates are in the rootfs
    mkdir -p /rootfs/etc/ssl/certs && \
    cp -r /etc/ssl/certs/* /rootfs/etc/ssl/certs/ 2>/dev/null || true && \
    cp /etc/ssl/cert.pem /rootfs/etc/ssl/cert.pem 2>/dev/null || true && \
    echo "âœ… CA certificates bundled" && \
    ls -la /rootfs/etc/ssl/certs/ | head -5 && \
    # Copy pip-installed packages to site-packages
    cp -r /pip-packages/* /rootfs/usr/lib/python3.11/site-packages/ 2>/dev/null || true && \
    echo "âœ… Pip packages copied to site-packages" && \
    ls /rootfs/usr/lib/python3.11/site-packages/ | head -20

# ============================================================================
# Final stage: bundle everything
# ============================================================================
FROM builder

# Copy Alpine rootfs from Alpine image (already includes musl-built libak.so)
COPY --from=alpine-rootfs /rootfs /tmp/nanos-root

# Copy Authority Python SDK to rootfs
RUN mkdir -p /tmp/nanos-root/usr/lib/python3.11/site-packages && \
    cp -r /nanos/sdk/python/authority_nanos /tmp/nanos-root/usr/lib/python3.11/site-packages/ && \
    echo "âœ… Authority SDK copied to rootfs"

# Verify Python and Authority components are there
RUN echo "âœ… Alpine rootfs bundled" && \
    ls -lh /tmp/nanos-root/usr/bin/python3.11 && \
    ls -lh /tmp/nanos-root/usr/lib/python3.11/encodings/__init__.py && \
    ls -lh /tmp/nanos-root/lib/libak.so && \
    ls -lh /tmp/nanos-root/usr/lib/python3.11/site-packages/authority_nanos/__init__.py && \
    echo "ðŸ“¦ Checking pip packages:" && \
    ls /tmp/nanos-root/usr/lib/python3.11/site-packages/ | grep -E "^(requests|httpx|openai|anthropic|langchain|crewai)" | head -10 || echo "âš ï¸ Some packages may be missing" && \
    echo "ðŸ” Checking CA certificates:" && \
    ls /tmp/nanos-root/etc/ssl/certs/ 2>/dev/null | wc -l | xargs -I{} echo "   {} certificate files found" && \
    du -sh /tmp/nanos-root

# Verify we have kernel and Python
RUN echo "Checking artifacts:" && \
    if [ -f /nanos/output/platform/pc/bin/kernel.img ]; then \
      echo "âœ… Kernel found"; \
      ls -lh /nanos/output/platform/pc/bin/kernel.img; \
    else \
      echo "âš ï¸ Kernel not found"; \
    fi && \
    echo "âœ… Python rootfs ready: $(ls -lh /tmp/nanos-root/bin/python3 | awk '{print $5}')"

# Create test script
RUN cat > /run-test.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”§ Authority Nanos - Python Execution Test"
echo "==========================================="
echo ""

cd /nanos

echo "ðŸ“ Environment:"
echo "   Kernel: $(ls -lh output/platform/pc/bin/kernel.img | awk '{print $5}')"
echo "   Python: $(ls -lh /tmp/nanos-root/usr/bin/python3.11 | awk '{print $5}')"
echo "   minops: $(ls -lh tools/minops/minops | awk '{print $5}')"
echo "   mkfs: $(ls -lh output/tools/bin/mkfs | awk '{print $5}')"
echo ""

echo "ðŸ Testing Python execution in Nanos kernel..."
echo ""

# Set PATH to include tools directory
export PATH="/nanos/output/tools/bin:$PATH"

# Run Python test with timeout
timeout 20 tools/minops/minops run examples/test-python.py -m 512 2>&1 || true

echo ""
echo "âœ… Test execution completed"
EOF

RUN chmod +x /run-test.sh

# Set default command
CMD ["/run-test.sh"]
