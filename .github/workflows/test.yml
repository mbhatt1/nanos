name: Tests

on:
  push:
    branches:
      - master
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - master

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm build-essential qemu-system-x86

      - name: Build kernel
        run: |
          make -j$(nproc) kernel PLATFORM=pc

      - name: Run unit tests
        run: |
          make test-unit || echo "Unit tests not yet configured"

  runtime-tests:
    name: Runtime Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm build-essential qemu-system-x86

      - name: Build kernel
        run: |
          make -j$(nproc) kernel PLATFORM=pc

      - name: Run runtime tests
        run: |
          make test-runtime || echo "Runtime tests not yet configured"

  authority-kernel-tests:
    name: Authority Kernel Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build and run AK unit tests
        run: |
          cd test/unit && make clean && make
          echo "=== Running AK Tests ==="
          cd ../../output/test/unit/bin
          for test in ak_*; do
            if [ -x "$test" ]; then
              echo "Running $test..."
              ./"$test" || exit 1
            fi
          done

  macos-build-test:
    name: macOS Build Test
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          brew install nasm x86_64-elf-binutils aarch64-elf-binutils

      - name: Build x86_64
        run: |
          make -j$(sysctl -n hw.ncpu) kernel PLATFORM=pc

      - name: Build ARM64
        run: |
          make clean
          make -j$(sysctl -n hw.ncpu) kernel PLATFORM=virt
