name: Publish Python SDK to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PyPI upload)'
        required: false
        default: 'false'
        type: boolean
      test_pypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  id-token: write  # Required for OIDC trusted publishing

jobs:
  # ============================================================================
  # Build Kernel Binaries for All Platforms
  # ============================================================================
  build-kernel-linux-x86_64:
    name: Build Kernel (Linux x86_64)
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.18'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/apt
            ~/go/pkg/mod
          key: ${{ runner.os }}-kernel-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-kernel-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm build-essential qemu-system-x86 wget

      - name: Build kernel and libak
        run: |
          make clean
          make -j$(nproc) PLATFORM=pc all-binaries
          ls -lh output/platform/pc/bin/kernel.img
          ls -lh output/platform/pc/lib/libak.so

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-linux-x86_64
          path: |
            output/platform/pc/bin/kernel.img
            output/platform/pc/lib/libak.so
          retention-days: 7

  build-kernel-linux-arm64:
    name: Build Kernel (Linux ARM64)
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.18'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/apt
            ~/go/pkg/mod
          key: ${{ runner.os }}-arm64-kernel-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-arm64-kernel-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm build-essential gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu qemu-system-arm wget

      - name: Build kernel and libak
        run: |
          make clean
          make -j$(nproc) PLATFORM=virt CROSS_COMPILE=aarch64-linux-gnu- all-binaries
          ls -lh output/platform/virt/bin/kernel.img
          ls -lh output/platform/virt/lib/libak.so

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-linux-arm64
          path: |
            output/platform/virt/bin/kernel.img
            output/platform/virt/lib/libak.so
          retention-days: 7

  build-kernel-macos-x86_64:
    name: Build Kernel (macOS x86_64)
    runs-on: macos-13
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            /Library/Caches/Homebrew
          key: ${{ runner.os }}-x86-kernel-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-x86-kernel-

      - name: Install dependencies
        run: |
          brew install nasm go wget qemu

      - name: Build kernel and libak
        run: |
          make clean
          make -j$(sysctl -n hw.ncpu) PLATFORM=pc all-binaries
          ls -lh output/platform/pc/bin/kernel.img
          ls -lh output/platform/pc/lib/libak.dylib

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-macos-x86_64
          path: |
            output/platform/pc/bin/kernel.img
            output/platform/pc/lib/libak.dylib
          retention-days: 7

  build-kernel-macos-arm64:
    name: Build Kernel (macOS ARM64)
    runs-on: macos-14
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo
            /Library/Caches/Homebrew
          key: ${{ runner.os }}-arm64-kernel-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-arm64-kernel-

      - name: Install dependencies
        run: |
          brew install nasm go wget qemu aarch64-elf-binutils

      - name: Build kernel and libak
        run: |
          make clean
          make -j$(sysctl -n hw.ncpu) PLATFORM=virt all-binaries
          ls -lh output/platform/virt/bin/kernel.img
          ls -lh output/platform/virt/lib/libak.dylib

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-macos-arm64
          path: |
            output/platform/virt/bin/kernel.img
            output/platform/virt/lib/libak.dylib
          retention-days: 7

  # ============================================================================
  # Build Python Wheels with cibuildwheel
  # ============================================================================
  build-wheels-linux:
    name: Build Wheels (Linux)
    needs: [build-kernel-linux-x86_64, build-kernel-linux-arm64]
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download kernel artifact (x86_64)
        if: matrix.arch == 'x86_64'
        uses: actions/download-artifact@v4
        with:
          name: kernel-linux-x86_64
          path: kernel-artifacts

      - name: Download kernel artifact (arm64)
        if: matrix.arch == 'aarch64'
        uses: actions/download-artifact@v4
        with:
          name: kernel-linux-arm64
          path: kernel-artifacts

      - name: Prepare binaries directory
        run: |
          mkdir -p sdk/python/authority_nanos/_binaries/linux_${{ matrix.arch == 'aarch64' && 'arm64' || 'x86_64' }}

          # Copy kernel.img and libak.so from the correct location
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            cp kernel-artifacts/output/platform/pc/bin/kernel.img \
               sdk/python/authority_nanos/_binaries/linux_x86_64/
            cp kernel-artifacts/output/platform/pc/lib/libak.so \
               sdk/python/authority_nanos/_binaries/linux_x86_64/
          else
            cp kernel-artifacts/output/platform/virt/bin/kernel.img \
               sdk/python/authority_nanos/_binaries/linux_arm64/
            cp kernel-artifacts/output/platform/virt/lib/libak.so \
               sdk/python/authority_nanos/_binaries/linux_arm64/
          fi

          ls -lah sdk/python/authority_nanos/_binaries/

      - name: Set up QEMU for cross-compilation
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.16.5

      - name: Build wheels
        run: |
          cd sdk/python
          python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          CIBW_SKIP: "*-musllinux_* *-manylinux_i686"
          CIBW_ARCHS_LINUX: ${{ matrix.arch }}
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux2014
          CIBW_BEFORE_BUILD: "pip install setuptools wheel"
          CIBW_TEST_COMMAND: "python -c 'import authority_nanos; print(authority_nanos.__version__)'"
          CIBW_TEST_SKIP: "*-manylinux_aarch64"  # Skip tests on emulated ARM64

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.arch }}
          path: sdk/python/wheelhouse/*.whl
          retention-days: 7

  build-wheels-macos:
    name: Build Wheels (macOS)
    needs: [build-kernel-macos-x86_64, build-kernel-macos-arm64]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        include:
          - os: macos-13
            arch: x86_64
            platform_tag: macos_x86_64
            kernel_artifact: kernel-macos-x86_64
            platform_dir: pc
          - os: macos-14
            arch: arm64
            platform_tag: macos_arm64
            kernel_artifact: kernel-macos-arm64
            platform_dir: virt
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download kernel artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.kernel_artifact }}
          path: kernel-artifacts

      - name: Prepare binaries directory
        run: |
          mkdir -p sdk/python/authority_nanos/_binaries/${{ matrix.platform_tag }}

          cp kernel-artifacts/output/platform/${{ matrix.platform_dir }}/bin/kernel.img \
             sdk/python/authority_nanos/_binaries/${{ matrix.platform_tag }}/
          cp kernel-artifacts/output/platform/${{ matrix.platform_dir }}/lib/libak.dylib \
             sdk/python/authority_nanos/_binaries/${{ matrix.platform_tag }}/

          ls -lah sdk/python/authority_nanos/_binaries/

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.16.5

      - name: Build wheels
        run: |
          cd sdk/python
          python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          CIBW_ARCHS_MACOS: ${{ matrix.arch }}
          CIBW_BEFORE_BUILD: "pip install setuptools wheel"
          CIBW_TEST_COMMAND: "python -c 'import authority_nanos; print(authority_nanos.__version__)'"
          CIBW_ENVIRONMENT_MACOS: "MACOSX_DEPLOYMENT_TARGET=10.9"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.arch }}
          path: sdk/python/wheelhouse/*.whl
          retention-days: 7

  # ============================================================================
  # Build Source Distribution
  # ============================================================================
  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: python -m pip install build

      - name: Build sdist
        run: |
          cd sdk/python
          python -m build --sdist
          ls -lah dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: sdk/python/dist/*.tar.gz
          retention-days: 7

  # ============================================================================
  # Test Wheel Installation
  # ============================================================================
  test-wheels:
    name: Test Wheels
    needs: [build-wheels-linux, build-wheels-macos]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            python: '3.9'
            wheel_artifact: wheels-linux-x86_64
          - os: ubuntu-22.04
            python: '3.11'
            wheel_artifact: wheels-linux-x86_64
          - os: macos-13
            python: '3.11'
            wheel_artifact: wheels-macos-x86_64
          - os: macos-14
            python: '3.11'
            wheel_artifact: wheels-macos-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.wheel_artifact }}
          path: wheels

      - name: Install wheel
        run: |
          # Find and install the matching wheel for this Python version
          PYTHON_VERSION=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          echo "Looking for wheel matching Python $PYTHON_VERSION"

          WHEEL=$(find wheels -name "*${PYTHON_VERSION}*.whl" | head -1)
          if [ -z "$WHEEL" ]; then
            # Try any wheel for this platform
            WHEEL=$(find wheels -name "*.whl" | head -1)
          fi

          if [ -z "$WHEEL" ]; then
            echo "No matching wheel found!"
            ls -la wheels/
            exit 1
          fi

          echo "Installing wheel: $WHEEL"
          pip install "$WHEEL"

      - name: Test import
        run: |
          python -c "
          import authority_nanos
          print(f'SDK Version: {authority_nanos.__version__}')
          print(f'Author: {authority_nanos.__author__}')

          # Test core imports
          from authority_nanos import (
              AuthorityKernel,
              Handle,
              ToolCall,
              Syscall,
              ErrorCode,
          )
          print('Core imports successful')

          # Test exception imports
          from authority_nanos import (
              AuthorityKernelError,
              OperationDeniedError,
              CapabilityError,
              InvalidArgumentError,
          )
          print('Exception imports successful')

          # Test binary locator (should find bundled binary)
          from authority_nanos._libak_loader import (
              get_platform_tag,
              get_libak_filename,
              LibakBinaryLocator,
          )
          platform = get_platform_tag()
          filename = get_libak_filename()
          print(f'Platform: {platform}, Library: {filename}')

          # Try to find the bundled binary
          bundled_path = LibakBinaryLocator.get_bundled_path()
          if bundled_path:
              print(f'Found bundled binary at: {bundled_path}')
          else:
              print('No bundled binary found (expected in development)')

          print('All tests passed!')
          "

      - name: Test basic functionality (without kernel)
        run: |
          python -c "
          from authority_nanos import AuthorityKernel, LibakError

          # Test that we can instantiate the class
          # This should fail gracefully since we don't have libak loaded
          try:
              ak = AuthorityKernel()
              print('AuthorityKernel instantiated (libak found)')
          except LibakError as e:
              print(f'Expected error (libak not in path): {e.code}')
              print('This is normal for wheel testing without kernel')
          except Exception as e:
              print(f'Unexpected error: {type(e).__name__}: {e}')

          print('Functionality test completed')
          "

  # ============================================================================
  # Publish to PyPI
  # ============================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: [test-wheels, build-sdist]
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    environment:
      name: pypi
      url: https://pypi.org/project/authority-nanos/
    permissions:
      id-token: write  # Required for OIDC trusted publishing
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect all distributions
        run: |
          mkdir -p dist

          # Collect wheels from all platforms
          find artifacts -name "*.whl" -exec cp {} dist/ \;

          # Collect source distribution
          find artifacts -name "*.tar.gz" -exec cp {} dist/ \;

          echo "=== Distribution files ==="
          ls -lah dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install twine
        run: python -m pip install twine

      - name: Verify distributions
        run: |
          python -m twine check dist/*
          echo "All distributions are valid!"

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            TAG=${{ github.ref }}
            VERSION=${TAG#refs/tags/v}
          else
            VERSION="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Publish to TestPyPI
        if: github.event.inputs.test_pypi == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true

      - name: Publish to PyPI
        if: github.event.inputs.dry_run != 'true' && github.event.inputs.test_pypi != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true

      - name: Dry run - show what would be published
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "=== DRY RUN - Would publish these files to PyPI ==="
          ls -lah dist/
          echo ""
          echo "=== Package contents ==="
          for f in dist/*.whl; do
            echo "--- $f ---"
            python -m zipfile -l "$f" | head -20
            echo "..."
          done

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [publish-pypi]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect distributions
        run: |
          mkdir -p release-assets
          find artifacts -name "*.whl" -exec cp {} release-assets/ \;
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;

          # Create checksums
          cd release-assets
          sha256sum *.whl *.tar.gz > SHA256SUMS.txt
          cd ..

          ls -lah release-assets/

      - name: Extract version
        id: version
        run: |
          TAG=${{ github.ref }}
          VERSION=${TAG#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Python SDK v${{ steps.version.outputs.version }}
          body: |
            ## Authority Nanos Python SDK v${{ steps.version.outputs.version }}

            ### Installation

            ```bash
            pip install authority-nanos==${{ steps.version.outputs.version }}
            ```

            ### Supported Platforms

            - Linux x86_64 (manylinux2014)
            - Linux ARM64/aarch64 (manylinux2014)
            - macOS x86_64 (10.9+)
            - macOS ARM64 (11.0+)

            ### Python Versions

            - Python 3.8
            - Python 3.9
            - Python 3.10
            - Python 3.11
            - Python 3.12

            ### Checksums

            See `SHA256SUMS.txt` for file checksums.
          files: |
            release-assets/*.whl
            release-assets/*.tar.gz
            release-assets/SHA256SUMS.txt
          draft: false
          prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
