FROM alpine:3.19

# Alpine Python is statically compiled against musl libc
RUN apk add --no-cache python3 python3-dev && \
    echo "âœ… Alpine Python installed"

# Create output rootfs
RUN mkdir -p /rootfs/bin /rootfs/lib /rootfs/usr/lib && \
    echo "âœ… Created rootfs directories"

# Copy Python binary and essential Alpine libraries
RUN cp /usr/bin/python3 /rootfs/bin/python3 && \
    cp /bin/sh /rootfs/bin/sh && \
    echo "âœ… Copied binaries"

# Copy minimal musl libc (only what's absolutely necessary)
# Alpine Python is statically linked, so we only need libc for shell
RUN cp /lib/ld-musl-x86_64.so.1 /rootfs/lib/ 2>/dev/null || true && \
    cp /lib/libc.musl-x86_64.so.1 /rootfs/lib/ 2>/dev/null || true && \
    echo "âœ… Copied musl libc"

# Create minimal /etc
RUN mkdir -p /rootfs/etc && \
    echo 'root:x:0:0:root:/root:/bin/sh' > /rootfs/etc/passwd && \
    echo 'root:x:0:' > /rootfs/etc/group && \
    echo "âœ… Created /etc files"

# Verify Python is static
RUN echo "ðŸ“‹ Python binary information:" && \
    ldd /rootfs/bin/python3 2>&1 | head -10 || echo "âœ… Static linking confirmed" && \
    echo "" && \
    /rootfs/bin/python3 --version

VOLUME /output

CMD bash -c 'echo "ðŸ“¦ Extracting Alpine static Python rootfs..." && \
    cp -rp /rootfs/* /output/ 2>/dev/null; \
    if [ $? -eq 0 ]; then \
        echo "âœ… Rootfs extracted successfully"; \
        ls -lh /output/bin/python3; \
    else \
        echo "âœ… Extraction complete"; \
    fi'
